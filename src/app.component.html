<!-- Global Effects -->
<app-background-slider [photos]="backgroundPhotos()" />
<app-particle-effect />
<app-audio-player />

<div class="relative min-h-screen z-10 font-sans text-white flex flex-col justify-between selection:bg-rose-500 selection:text-white">

  <!-- Top Navigation (Elegant & Minimal) -->
  <div class="fixed top-0 left-0 w-full p-6 md:p-8 flex justify-between items-start z-40 pointer-events-none">
    <div class="flex flex-col">
      <div class="text-[10px] font-bold tracking-[0.5em] text-rose-200/80 uppercase mb-1">
        Lumina · Chapter 20
      </div>
      <div class="h-[1px] w-12 bg-rose-500/50"></div>
    </div>

    <!-- Progress Dots (Updated for 6 stages: 0-5) -->
    <div class="flex flex-col gap-3 items-center mr-16 md:mr-0">
      @for (step of [0,1,2,3,4,5]; track step) {
        <div 
          class="w-1.5 rounded-full transition-all duration-700 shadow-[0_0_10px_rgba(255,255,255,0.5)] border border-white/10"
          [class.h-6]="currentStage() === step"
          [class.bg-rose-400]="currentStage() === step"
          [class.h-1.5]="currentStage() !== step"
          [class.bg-white/20]="currentStage() !== step"
        ></div>
      }
    </div>
  </div>

  <!-- Main Stage Container -->
  <main class="flex-grow flex flex-col justify-center items-center w-full max-w-6xl mx-auto p-6 transition-all duration-1000 ease-in-out relative z-30">
    
    <!-- STAGE 0: INTRO -->
    @if (currentStage() === 0) {
      <div class="text-center flex flex-col items-center justify-center min-h-[75vh] w-full max-w-2xl relative">
        <div class="absolute inset-0 bg-gradient-to-r from-rose-500/20 to-purple-500/20 blur-[100px] rounded-full pointer-events-none animate-pulse duration-[5000ms]"></div>

        <div class="animate-fade-up-stagger-1 relative z-10">
          <p class="text-rose-200 text-xs md:text-sm tracking-[0.6em] mb-6 uppercase font-medium border border-rose-500/20 px-4 py-2 rounded-full inline-block backdrop-blur-sm bg-white/5">
            The 20th Chapter
          </p>
        </div>
        
        <div class="animate-fade-up-stagger-2 relative z-10">
           <h1 class="font-serif text-6xl md:text-8xl lg:text-9xl mb-2 leading-tight tracking-tight text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-rose-200 drop-shadow-xl">
            致 你的<br><span class="italic text-rose-400">二十岁</span>
          </h1>
        </div>
        
        <div class="animate-grow-line relative my-10 flex flex-col items-center gap-2">
           <div class="w-px h-16 bg-gradient-to-b from-transparent via-rose-400 to-transparent"></div>
           <div class="w-2 h-2 rotate-45 border border-rose-400/50"></div>
        </div>
        
        <button 
          (click)="startJourney()" 
          class="animate-fade-up-stagger-3 group relative px-12 py-5 bg-white/5 hover:bg-white/10 backdrop-blur-md border border-white/20 rounded-full transition-all duration-500 cursor-pointer overflow-hidden mt-2 z-50 hover:scale-105 active:scale-95 shadow-[0_0_40px_rgba(244,63,94,0.15)] hover:shadow-[0_0_60px_rgba(244,63,94,0.3)]"
        >
          <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000"></div>
          <div class="flex items-center gap-4 text-white">
            <span class="text-sm tracking-[0.3em] uppercase font-semibold text-rose-100">Start Journey</span>
            <svg class="w-4 h-4 group-hover:translate-x-2 transition-transform text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
          </div>
        </button>
      </div>
    }

    <!-- STAGE 1: STATS (NEW) -->
    @if (currentStage() === 1) {
      <div class="w-full animate-fade-in pt-24 min-h-[60vh] flex flex-col justify-center">
        <div class="text-center mb-16 relative">
          <h2 class="font-serif text-5xl md:text-7xl mb-4 text-white drop-shadow-lg">爱的 · 算式</h2>
          <p class="text-rose-300/80 text-xs tracking-[0.5em] uppercase">The Numbers of Us</p>
        </div>
        
        <app-stats-view [stats]="relationshipStats()" />
        
        <div class="flex justify-center mt-12">
           <button (click)="nextStage()" class="group text-white/50 hover:text-white transition-colors flex flex-col items-center gap-2">
             <span class="text-[10px] tracking-widest uppercase">Explore Memories</span>
             <svg class="w-5 h-5 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
           </button>
        </div>
      </div>
    }

    <!-- STAGE 2: TIMELINE -->
    @if (currentStage() === 2) {
      <div class="w-full animate-fade-in pt-24">
        <div class="text-center mb-24 relative">
          <h2 class="font-serif text-5xl md:text-7xl mb-4 text-white drop-shadow-lg">时光 · 印记</h2>
          <p class="text-rose-300/80 text-xs tracking-[0.5em] uppercase">Chronicles of Us</p>
        </div>
        <app-timeline-view [items]="memories()" />
        
        <div class="flex justify-center pb-32 pt-12">
           <button (click)="nextStage()" class="group relative px-8 py-3 overflow-hidden rounded-full bg-white/5 hover:bg-white/10 border border-white/10 transition-all">
             <div class="flex flex-col items-center">
               <span class="text-[10px] tracking-widest uppercase mb-1 text-rose-200">See Photos</span>
               <svg class="w-4 h-4 text-white/60 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
             </div>
           </button>
        </div>
      </div>
    }

    <!-- STAGE 3: PHOTO ALBUM (New) -->
    @if (currentStage() === 3) {
      <div class="w-full animate-fade-in pt-24 h-full">
        <div class="text-center mb-20">
           <h2 class="font-serif text-5xl md:text-7xl mb-4 text-white drop-shadow-lg">定格 · 瞬间</h2>
           <p class="text-rose-300/80 text-xs tracking-[0.5em] uppercase">Photo Album</p>
        </div>
        
        <!-- Replaced GalleryView with PhotoAlbumComponent -->
        <app-photo-album [items]="memories()" />
        
        <div class="flex justify-center mt-12 pb-32">
           <button (click)="nextStage()" class="group relative inline-flex items-center justify-center px-8 py-3 overflow-hidden font-medium tracking-tighter text-white bg-rose-900/40 rounded-full border border-rose-500/30">
             <span class="relative text-xs tracking-[0.2em] uppercase flex items-center gap-2">
               Future Wishes →
             </span>
           </button>
        </div>
      </div>
    }

    <!-- STAGE 4: BUCKET LIST (NEW) -->
    @if (currentStage() === 4) {
      <div class="w-full animate-fade-in pt-24 h-full">
        <div class="text-center mb-20">
           <h2 class="font-serif text-5xl md:text-7xl mb-4 text-white drop-shadow-lg">未来 · 期许</h2>
           <p class="text-rose-300/80 text-xs tracking-[0.5em] uppercase">Our Bucket List</p>
        </div>
        
        <app-bucket-list [items]="bucketList()" />
        
        <div class="flex justify-center mt-20 pb-32">
           <button (click)="nextStage()" class="px-10 py-4 border border-white/20 bg-black/40 backdrop-blur-md rounded-full hover:bg-white hover:text-black transition-all duration-500 text-xs tracking-[0.2em] uppercase shadow-lg hover:shadow-[0_0_30px_rgba(255,255,255,0.4)]">
             有一封信给你 →
           </button>
        </div>
      </div>
    }

    <!-- STAGE 5: LETTER -->
    @if (currentStage() === 5) {
      <div class="w-full animate-fade-in pt-16">
        <app-letter-view [content]="finalLetter()" />
        
        <div class="text-center mt-32 opacity-40 hover:opacity-100 transition-opacity duration-1000 pb-20">
          <button (click)="currentStage.set(0)" class="text-[10px] tracking-widest uppercase text-white hover:text-rose-300 flex items-center justify-center gap-2 mx-auto">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            Replay Memory
          </button>
        </div>
      </div>
    }

  </main>

  <!-- Hidden Admin Trigger -->
  <div class="fixed bottom-4 right-4 z-[60]">
    <button (click)="toggleEditMode()" class="w-8 h-8 rounded-full bg-transparent hover:bg-white/5 transition-colors cursor-default"></button>
  </div>

  @if (isEditMode()) {
    <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-xl animate-fade-in">
      <div class="relative w-full max-w-lg px-4">
        <button (click)="toggleEditMode()" class="absolute -top-12 right-4 text-white/50 hover:text-white transition-colors uppercase text-xs tracking-widest">Close</button>
        <app-ai-composer (contentUpdated)="updateLetter($event)" (memoryAdded)="addMemory($event)" />
      </div>
    </div>
  }

</div>

<style>
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes growLine {
    from { height: 0; opacity: 0; }
    to { height: 8rem; opacity: 1; }
  }
  .animate-fade-up-stagger-1 { animation: fadeUp 1s ease-out forwards 0.2s; opacity: 0; }
  .animate-fade-up-stagger-2 { animation: fadeUp 1s ease-out forwards 0.5s; opacity: 0; }
  .animate-fade-up-stagger-3 { animation: fadeUp 1s ease-out forwards 1.2s; opacity: 0; }
  .animate-grow-line { animation: growLine 1.5s ease-out forwards 0.8s; opacity: 0; }
  
  .animate-fade-in {
    animation: fadeUp 0.8s ease-out forwards;
  }
</style>